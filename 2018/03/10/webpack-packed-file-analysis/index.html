<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="keywords" content="前端周记,前端开发,前端分享,前端实践,FE,Front End,React,React Native,NodeJS,Vue,Electron"><meta name="description" content="前端周记,前端分享,前端实践,前端技术文章翻译,项目总结,知识点记录,心得体会分享,新技术调研。好记性不如烂笔头,记录自己做项目过程中的一些心得体会,遇到过并填过的坑以及自平时己学习的新知识,摸过的鱼。"><meta name="baidu-site-verification" content="gC9bUYul0P"><title>webpack 打包后代码分析 | ~Refresh的前端之路</title><link rel="stylesheet" type="text/css" href="https://blog.wfuny.com/css/style.css?v=1.0.1"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">webpack 打包后代码分析</h1><a id="logo" href="/.">~Refresh的前端之路</a><p class="description">一条道走到黑</p></div><div id="nav-menu"><a href="/." class="current"><span class="icon icon-home"></span><span class="menu-txt">首页</span></a><a href="/archives/"><span class="icon icon-archive"></span><span class="menu-txt">归档</span></a><a href="/about/"><span class="icon icon-about"></span><span class="menu-txt">关于</span></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><!--if page.type == 'original'--><!--  div.watermark.original--><!--if page.type == 'translate'--><!--  div.watermark.translate--><!--if page.type == 'recommend'--><!--  div.watermark.recommend--><h1 class="post-title">webpack 打包后代码分析</h1><div class="post-meta">Mar 10, 2018<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>目前估计在前端构建打包工具中大家用的最多的就是webpack，它能够使我们进行模块化编程，使用ES6提供的模块语法糖进行开发，还允许我们使用ES6带来的各种新特性，允许我们提取公共代码块，对js进行混淆压缩等等前端构建中所需要的功能。这篇文章主要对打包后的js代码进行分析，看看 webpack 是怎么支持模块化的。</p>
<h2 id="单个入口文件，无其他代码块，无异步加载情况"><a href="#单个入口文件，无其他代码块，无异步加载情况" class="headerlink" title="单个入口文件，无其他代码块，无异步加载情况"></a>单个入口文件，无其他代码块，无异步加载情况</h2><p>定义如下两个模块文件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// module-a/index.js</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a,b</span>) </span>&#123;</div><div class="line">	<span class="keyword">return</span> a + b;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// module-b/index.js</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">minus</span>(<span class="params">a,b</span>) </span>&#123;</div><div class="line">	<span class="keyword">return</span> a - b;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>定义入口文件如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> add <span class="keyword">from</span> <span class="string">'./module-a'</span>;</div><div class="line"><span class="keyword">import</span> minus <span class="keyword">from</span> <span class="string">'./module-b'</span>;</div><div class="line"></div><div class="line">alert(add(<span class="number">1</span>,<span class="number">2</span>));</div><div class="line">alert(minus(<span class="number">4</span>,<span class="number">2</span>));</div></pre></td></tr></table></figure>
<p>打完包的代码简化了一下大概如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>) </span>&#123; <span class="comment">// webpackBootstrap</span></div><div class="line">	<span class="keyword">var</span> installedModules = &#123;&#125;;</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>&#123;</div><div class="line">		<span class="keyword">if</span>(installedModules[moduleId]) &#123;</div><div class="line"> 			<span class="keyword">return</span> installedModules[moduleId].exports;</div><div class="line"> 		&#125;</div><div class="line">		<span class="keyword">var</span> <span class="built_in">module</span> = installedModules[moduleId] = &#123;</div><div class="line"> 			<span class="attr">i</span>: moduleId,</div><div class="line"> 			<span class="attr">l</span>: <span class="literal">false</span>,</div><div class="line"> 			<span class="attr">exports</span>: &#123;&#125;</div><div class="line"> 		&#125;;</div><div class="line">		modules[moduleId].call(<span class="built_in">module</span>.exports, <span class="built_in">module</span>, <span class="built_in">module</span>.exports, __webpack_require__);</div><div class="line"> 		<span class="built_in">module</span>.l = <span class="literal">true</span>;</div><div class="line">		<span class="keyword">return</span> <span class="built_in">module</span>.exports;</div><div class="line"> 	&#125;</div><div class="line">	</div><div class="line"> 	<span class="keyword">return</span> __webpack_require__(__webpack_require__.s = <span class="number">2</span>);</div><div class="line"> &#125;)([...]);<span class="comment">// 这个数组是不同模块的代码，和入口文件的代码，数组的下标就是moduleId</span></div></pre></td></tr></table></figure>
<p>通过上面代码，我们可以看出在这种打包情况下，所有代码模块会被进行语法转换，然后作为数组的方式传入。如上面的module-a/index.js 打包后的代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/***/</span></div><div class="line"><span class="comment">/* 0 */</span> <span class="comment">//这个地方的数字就是这个模块的id</span></div><div class="line"><span class="comment">/***/</span></div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">module, exports, __webpack_require__</span>) </span>&#123;</div><div class="line"><span class="meta"></span></div><div class="line">		"use strict";</div><div class="line">		<span class="built_in">Object</span>.defineProperty(exports, <span class="string">"__esModule"</span>, &#123;</div><div class="line">			<span class="attr">value</span>: <span class="literal">true</span></div><div class="line">		&#125;);</div><div class="line">		exports.default = add;</div><div class="line">		<span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</div><div class="line">			<span class="keyword">return</span> a + b;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>然后入口文件如下 ： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 2 */</span></div><div class="line"><span class="comment">/***/</span> </div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">module, exports, __webpack_require__</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> _moduleA = __webpack_require__(<span class="number">0</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">var</span> _moduleB = __webpack_require__(<span class="number">1</span>);</div><div class="line">    </div><div class="line">    alert((<span class="number">0</span>, _moduleA.default)(<span class="number">1</span>, <span class="number">2</span>));</div><div class="line">    </div><div class="line">    alert((<span class="number">0</span>, _moduleB.default)(<span class="number">4</span>, <span class="number">2</span>));</div><div class="line"></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>这里也对入口文件做了部分简化，可以看出入口文件的id为2，在打包后的文件中，最关键的一个方法就是<code>__webpack_require__</code> 这个方法主要作用就是执行对应模块id的的代码，返回module.exports , 对执行过的模块会有个缓存对象 installedModules 进行标识，所以即使多个模块引用了某个模块多遍，那这个模块也不会被执行两遍。从上面打包后的代码来看，入口文件moduleId 是2 ，前webpack会首先进行require ， <code>_webpack_require__(__webpack_require__.s = 2);</code> 并把结果进行返回，在这个过程中所有依赖关系都会被进行require，并缓存，以免重复执行。</p>
<h2 id="单个入口文件，抽出公共代码块，无异步加载"><a href="#单个入口文件，抽出公共代码块，无异步加载" class="headerlink" title="单个入口文件，抽出公共代码块，无异步加载"></a>单个入口文件，抽出公共代码块，无异步加载</h2><p>html 页面中的代码加载顺序。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"example"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"common.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"bundle.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure>
<p>主要看common.js中的一个方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">window</span>[<span class="string">"webpackJsonp"</span>] = <span class="function"><span class="keyword">function</span> <span class="title">webpackJsonpCallback</span>(<span class="params">chunkIds, moreModules, executeModules</span>) </span>&#123;</div><div class="line"><span class="comment">/******/</span> 		<span class="comment">// add "moreModules" to the modules object,</span></div><div class="line"><span class="comment">/******/</span> 		<span class="comment">// then flag all "chunkIds" as loaded and fire callback</span></div><div class="line"><span class="comment">/******/</span> 		<span class="keyword">var</span> moduleId, chunkId, i = <span class="number">0</span>, resolves = [], result;</div><div class="line"><span class="comment">/******/</span> 		<span class="keyword">for</span>(;i &lt; chunkIds.length; i++) &#123;</div><div class="line"><span class="comment">/******/</span> 			chunkId = chunkIds[i];</div><div class="line"><span class="comment">/******/</span> 			<span class="keyword">if</span>(installedChunks[chunkId]) &#123;</div><div class="line"><span class="comment">/******/</span> 				resolves.push(installedChunks[chunkId][<span class="number">0</span>]);</div><div class="line"><span class="comment">/******/</span> 			&#125;</div><div class="line"><span class="comment">/******/</span> 			installedChunks[chunkId] = <span class="number">0</span>;</div><div class="line"><span class="comment">/******/</span> 		&#125;</div><div class="line"><span class="comment">/******/</span> 		<span class="keyword">for</span>(moduleId <span class="keyword">in</span> moreModules) &#123;</div><div class="line"><span class="comment">/******/</span> 			<span class="keyword">if</span>(<span class="built_in">Object</span>.prototype.hasOwnProperty.call(moreModules, moduleId)) &#123;</div><div class="line"><span class="comment">/******/</span> 				modules[moduleId] = moreModules[moduleId];</div><div class="line"><span class="comment">/******/</span> 			&#125;</div><div class="line"><span class="comment">/******/</span> 		&#125;</div><div class="line"><span class="comment">/******/</span> 		<span class="keyword">if</span>(parentJsonpFunction) parentJsonpFunction(chunkIds, moreModules, executeModules);</div><div class="line"><span class="comment">/******/</span> 		<span class="keyword">while</span>(resolves.length) &#123;</div><div class="line"><span class="comment">/******/</span> 			resolves.shift()();</div><div class="line"><span class="comment">/******/</span> 		&#125;</div><div class="line"><span class="comment">/******/</span> 		<span class="keyword">if</span>(executeModules) &#123;</div><div class="line"><span class="comment">/******/</span> 			<span class="keyword">for</span>(i=<span class="number">0</span>; i &lt; executeModules.length; i++) &#123;</div><div class="line"><span class="comment">/******/</span> 				result = __webpack_require__(__webpack_require__.s = executeModules[i]);</div><div class="line"><span class="comment">/******/</span> 			&#125;</div><div class="line"><span class="comment">/******/</span> 		&#125;</div><div class="line"><span class="comment">/******/</span> 		<span class="keyword">return</span> result;</div><div class="line"><span class="comment">/******/</span> 	&#125;;</div></pre></td></tr></table></figure>
<p>这个方法接受三个参数，分别是chunkIds,moreModules,executeModules , 在index.js 的调用方式如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">webpackJsonp([<span class="number">0</span>],[...]<span class="comment">/*所以依赖的模块代码内容*/</span>,[<span class="number">2</span>]<span class="comment">/*入口文件模块id*/</span>);</div></pre></td></tr></table></figure>
<p>这个和情况一其实差别不大。</p>
<h2 id="异步加载某个模块"><a href="#异步加载某个模块" class="headerlink" title="异步加载某个模块"></a>异步加载某个模块</h2><p>为了实现异步加载情况，修改入口文件代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> add <span class="keyword">from</span> <span class="string">'./module-a'</span>;</div><div class="line"></div><div class="line">alert(add(<span class="number">1</span>,<span class="number">2</span>));</div><div class="line"></div><div class="line"><span class="keyword">const</span> exampleNode = <span class="built_in">document</span>.getElementById(<span class="string">'example'</span>);</div><div class="line"></div><div class="line">exampleNode.addEventListener(<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">    <span class="built_in">require</span>.ensure([], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">const</span> minus = <span class="built_in">require</span>(<span class="string">'./module-b'</span>).default;</div><div class="line">        alert(minus(<span class="number">4</span>,<span class="number">2</span>));</div><div class="line">    &#125;)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>通过webpack打包后，入口文件的代码变成了如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">webpackJsonp([<span class="number">1</span>],[(</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">module, exports, __webpack_require_</span>) </span>&#123;</div><div class="line">        <span class="comment">// 这里是module-a/index.js的代码</span></div><div class="line">    &#125;</div><div class="line">),(</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">module, exports, __webpack_require__</span>) </span>&#123;</div><div class="line">        <span class="comment">// 这里是index.js 入口文件的代码，可以看到异步加载的模块代码webpack处理过后变成如下：</span></div><div class="line">        ... </div><div class="line">        alert((<span class="number">0</span>, _moduleA2.default)(<span class="number">1</span>, <span class="number">2</span>));</div><div class="line">    </div><div class="line">        <span class="keyword">var</span> exampleNode =   <span class="built_in">document</span>.getElementById(<span class="string">'example'</span>);</div><div class="line">    </div><div class="line">        exampleNode.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</div><div class="line">        __webpack_require__.e<span class="comment">/* require.ensure */</span>(<span class="number">0</span>).then((<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> minus = __webpack_require__(<span class="number">2</span>).default;</div><div class="line">            alert(minus(<span class="number">4</span>, <span class="number">2</span>));</div><div class="line">        &#125;).bind(<span class="literal">null</span>, __webpack_require__)).catch(__webpack_require__.oe);</div><div class="line">    &#125;);</div><div class="line"> &#125;</div><div class="line">)],[<span class="number">1</span>]);</div></pre></td></tr></table></figure>
<p>从打包后的代码中可以看出， 异步代码加载的关键函数是 <code>__webpack_require__.e</code> 这个方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 执行这个方法，返回的是一个promise </span></div><div class="line">__webpack_require__.e = <span class="function"><span class="keyword">function</span> <span class="title">requireEnsure</span>(<span class="params">chunkId</span>) </span>&#123;</div><div class="line">     <span class="comment">// 当我点击按钮的时候，异步加载块id为0的块内容。</span></div><div class="line">     <span class="comment">// 这个地方先判断是否已经执行过了</span></div><div class="line"> 		<span class="keyword">var</span> installedChunkData = installedChunks[chunkId];</div><div class="line"> 		<span class="keyword">if</span>(installedChunkData === <span class="number">0</span>) &#123;</div><div class="line">	      <span class="comment">// 如果为0 表示， 此块前面已经加载执行过了，直接返回离职resolve的promise,</span></div><div class="line">	      <span class="comment">// 相当于上面的代码then中的代码立即执行。</span></div><div class="line"> 			<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>&#123; resolve(); &#125;);</div><div class="line"> 		&#125;</div><div class="line"></div><div class="line"> 		<span class="comment">// a Promise means "currently loading".</span></div><div class="line"> 		<span class="keyword">if</span>(installedChunkData) &#123;</div><div class="line">	      <span class="comment">// 如果存在数据，且不为0 ，说明块正在加载，返回之前保存的 promise</span></div><div class="line"> 			<span class="keyword">return</span> installedChunkData[<span class="number">2</span>];</div><div class="line"> 		&#125;</div><div class="line"></div><div class="line"> 		<span class="comment">// setup Promise in chunk cache</span></div><div class="line"> 		<span class="comment">// 如果是首次加载，新创建一个promise,并设置installedChunks[chunkId] = [resolve,reject,promise] , 在执行webpackJsonp是有用。</span></div><div class="line"> 		<span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</div><div class="line"> 			installedChunkData = installedChunks[chunkId] = [resolve, reject];</div><div class="line"> 		&#125;);</div><div class="line"> 		installedChunkData[<span class="number">2</span>] = promise;</div><div class="line"></div><div class="line"> 		<span class="comment">// start chunk loading</span></div><div class="line"> 		<span class="comment">// 创建script标签加载块文件。</span></div><div class="line"> 		<span class="keyword">var</span> head = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'head'</span>)[<span class="number">0</span>];</div><div class="line"> 		<span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</div><div class="line"> 		script.type = <span class="string">'text/javascript'</span>;</div><div class="line"> 		script.charset = <span class="string">'utf-8'</span>;</div><div class="line"> 		script.async = <span class="literal">true</span>;</div><div class="line"> 		script.timeout = <span class="number">120000</span>;</div><div class="line"></div><div class="line"> 		<span class="keyword">if</span> (__webpack_require__.nc) &#123;</div><div class="line"> 			script.setAttribute(<span class="string">"nonce"</span>, __webpack_require__.nc);</div><div class="line"> 		&#125;</div><div class="line"> 		script.src = __webpack_require__.p + <span class="string">""</span> + chunkId + <span class="string">".js"</span>;</div><div class="line"> 		<span class="keyword">var</span> timeout = setTimeout(onScriptComplete, <span class="number">120000</span>);</div><div class="line"> 		script.onerror = script.onload = onScriptComplete;</div><div class="line"> 		<span class="function"><span class="keyword">function</span> <span class="title">onScriptComplete</span>(<span class="params"></span>) </span>&#123;</div><div class="line"> 			<span class="comment">// avoid mem leaks in IE.</span></div><div class="line"> 			script.onerror = script.onload = <span class="literal">null</span>;</div><div class="line"> 			clearTimeout(timeout);</div><div class="line"> 			<span class="keyword">var</span> chunk = installedChunks[chunkId];</div><div class="line"> 			<span class="keyword">if</span>(chunk !== <span class="number">0</span>) &#123;</div><div class="line"> 				<span class="keyword">if</span>(chunk) &#123;</div><div class="line"> 					chunk[<span class="number">1</span>](<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Loading chunk '</span> + chunkId + <span class="string">' failed.'</span>));</div><div class="line"> 				&#125;</div><div class="line"> 				installedChunks[chunkId] = <span class="literal">undefined</span>;</div><div class="line"> 			&#125;</div><div class="line"> 		&#125;;</div><div class="line"> 		<span class="comment">// 这里一旦设置到页面中，src加载并执行，看到0.js代码里，是开始执行webpackJsonp方法。</span></div><div class="line"> 		head.appendChild(script);</div><div class="line"></div><div class="line"> 		<span class="keyword">return</span> promise;</div><div class="line"> 	&#125;;</div></pre></td></tr></table></figure>
<p>通过script标签加载完块文件0.js在执行webpackJsonp的时候，<br><code>webpackJsonp([0],{0: (function(){/*块中代码*/})})</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span>(;i &lt; chunkIds.length; i++) &#123;</div><div class="line">	chunkId = chunkIds[i];</div><div class="line">	<span class="keyword">if</span>(installedChunks[chunkId]) &#123;</div><div class="line">		resolves.push(installedChunks[chunkId][<span class="number">0</span>]);</div><div class="line">	&#125;</div><div class="line">	installedChunks[chunkId] = <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个是候chunkIds为[0],有前面我们知道<code>installedChunks[0] = [resolve,reject,promise]</code> , 所以 resolves 中会加入这个块加载promise的resolve方法。 然后设置installedChunks[0] = 0;表明这个块已经加载执行过了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// webpackJsonp 中的另一段代码</span></div><div class="line"><span class="keyword">while</span>(resolves.length) &#123;</div><div class="line">	resolves.shift()(); <span class="comment">// 执行promise resolve 方法，然后通知then中的方法开始执行。</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过上面的代买促使下面的代码开始执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> minus = __webpack_require__(<span class="number">2</span>).default; <span class="comment">// 加载块模块导出的方法</span></div><div class="line">    alert(minus(<span class="number">4</span>, <span class="number">2</span>)); <span class="comment">// 执行方法</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>整个异步加载完成，可以看到webpack并没有在页面中删除添加的script标签。</p>
<p><img src="http://rainypin.qiniudn.com/15213581511046.jpg" alt="块0的script标签"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>模块加载的原理大同小异，在webpack出来之前，模块管理一般都通过模块加载器去管理，这类加载器，实现了模块依赖分析，模块递归加载，模块循环引用的解决等功能，而webpack主要在异步加载的情况下才会采用script去动态加载块文件代码，其他的模块其实都是作为数据存在于js文件中的，并通过函数包裹，避免变量的相互污染。</p>
</div><script type="text/javascript" src="https://blog.wfuny.com/js/share.js?v=1.0.1" async></script><a data-url="https://blog.wfuny.com/2018/03/10/webpack-packed-file-analysis/" data-id="cjewi0sf70024nd7q7nn6mi9p" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2018/03/05/react-redux/" class="next">react-redux 初探</a></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var cloudTieConfig = {
  url: document.location.href,
  sourceId: "",
  productKey: "151c661ff0ff41c18669a374d3f8f153",
  target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="搜索" type="text" name="q" results="0" autocomplete="off"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><span class="icon icon-category"></span><span class="widget-txt">分类</span></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MongoDB/">MongoDB</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NodeJS/">NodeJS</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/React/">React</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/React-Native/">React Native</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端大杂烩/">前端大杂烩</a><span class="category-list-count">8</span></li></ul></div><div class="widget"><div class="widget-title"><span class="icon icon-clip"></span><span class="widget-txt">标签</span></div><div class="tagcloud"><a href="/tags/npm/" style="font-size: 15px;">npm</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/前端大杂烩/" style="font-size: 15px;">前端大杂烩</a> <a href="/tags/NodeJS/" style="font-size: 15px;">NodeJS</a> <a href="/tags/源码学习/" style="font-size: 15px;">源码学习</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/Mongoose/" style="font-size: 15px;">Mongoose</a> <a href="/tags/Mongodb/" style="font-size: 15px;">Mongodb</a> <a href="/tags/React/" style="font-size: 15px;">React</a> <a href="/tags/React-Native/" style="font-size: 15px;">React Native</a> <a href="/tags/webpack/" style="font-size: 15px;">webpack</a> <a href="/tags/构建工具/" style="font-size: 15px;">构建工具</a></div></div><div class="widget"><div class="widget-title"><span class="icon icon-article"></span><span class="widget-txt">最新文章</span></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/03/10/webpack-packed-file-analysis/">webpack 打包后代码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/05/react-redux/">react-redux 初探</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/24/git-and-npm/">git 和 npm 常用命令汇总</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/08/webpack1-to-webpack2/">升级项目中的 webpack1.x 到 webpack2.x , 完善项目构建打包</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/06/event-proxy/">eventproxy 源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/05/fe-event-loop/">JavaScript 和 NodeJS 事件循环</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/03/javascript-event-loop/">什么是JavaScript 事件循环 ?</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/27/mongoose-tutorial-2/">Mongoose 学习笔记二 — Query 和 Population</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/26/react-life-cycle/">React 的生命周期</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/26/ngrok/">使用ngrok让你的本地mock可以提供给外网访问</a></li></ul></div><div class="widget"><div class="widget-title"><span class="icon icon-link"></span><span class="widget-txt">友情链接</span></div><ul></ul><a href="http://fex.baidu.com/" title="百度FEX" target="_blank">百度FEX</a><ul></ul><a href="http://www.aliued.com/" title="阿里巴巴UED" target="_blank">阿里巴巴UED</a><ul></ul><a href="http://f2e.souche.com/blog/" title="搜车大无线团队博客" target="_blank">搜车大无线团队博客</a><ul></ul><a href="http://fe.meituan.com/" title="美团前端团队博客" target="_blank">美团前端团队博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a>2018 </a><a href="/." rel="nofollow">~Refresh的前端之路</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="https://blog.wfuny.com/js/totop.js?v=1.0.1" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="https://blog.wfuny.com/js/fancybox.js?v=1.0.1" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="https://blog.wfuny.com/js/search.js?v=1.0.1"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?4c66f02c419b1b8b035290646cd20eaf";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script>(function () {
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><script type="text/javascript" src="https://blog.wfuny.com/js/codeblock-resizer.js?v=1.0.1"></script><script type="text/javascript" src="https://blog.wfuny.com/js/smartresize.js?v=1.0.1"></script></div></body></html>